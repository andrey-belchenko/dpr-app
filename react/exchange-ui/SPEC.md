## Содержание
1. [Перечень страниц приложения](#1-перечень-страниц-приложения)
2. [Функции компонентов интерфейса](#2-функции-компонентов-интерфейса)
3. [Аутентификация и авторизация](#3-аутентификация-и-авторизация)
4. [Отложенные сообщения и сопоставление](#4-отложенные-сообщения-и-сопоставление)
## 1. Перечень страниц приложения
Пункт меню | Описание 
--- | --- 
Главная | Дашборд для вывода сводной информации о состоянии интеграционного решения. В текущей реализации не содержит данных из БД, является примером. |
### 1.1. Витрины данных
Пункт меню | Описание | Сценарий № | Источник данных
--- | --- | --- | ---
Дерево объектов| Все объекты модели в виде иерархической структуры. Строится на основе связи IdentifiedObject.ParentObject. Повторяет дерево СК-11.| * | view_objectTree
Оборудование и контейнеры| Таблица отображает все объекты модели, которые находятся внутри контейнеров Line или Substation (корневой контейнер). Корневой контейнер задается полем IdentifiedObject.RootContainer, которое вычисляется по связям IdentifiedObject.ParentObject. | 1, 2, 3| view_objectTree
Объекты отпр. в СК-11 | Перечень объектов модели отправленных в СК-11. Строится на основе лога отправки в СК-11 и данных модели. Во многом по составу и содержанию данных повторяет страницу "Оборудование и контейнеры".| 1, 2, 3 | view_skSentObjects
Статус обраб. элем. сети | Перечень элементов сети, полученных из КИСУР (AccountPartLine и Switch), на основе которых производится формирование участков магистрали для СК-11. В таблице указан статус обработки каждого элемента. Возможные статусы: <ul><li>Обработан</li><li>Отсутствует подключение</li><li>Линия не сопоставлена</li></ul>| 3 | view_aplInfo
Состояние линий| Таблица отображает состояние линий (Line) входящих в них сегментов (ACLineSegment) и соединительных узлов (ConnectivityNode). Заполняется на основе данных информобмена в рамках сценария 4 "Запрос состояния линий".| 4 | view_NodesStatus
Состояния КА | Таблица - перечень линейных коммутационных аппаратов с указанием статуса полученного в рамках информобмена по сценарию 7. | 7 | view_skSwitchesStat
Диспетчерские пометки| Таблица - перечень диспетчерских пометок полученных в рамках информобмена по сценарию 8. | 8 | view_skMarkers
Предупреждения | Таблица - перечень предупреждений о нестыковках в данных. В данный момент предупреждения формируются в рамках информобмена по синариям 7,8. В таблице содержится текст предупреждения, развернув строку можно увидеть дополнительную информацию. | 7,8 | sys_Warning

### 1.2. Обогащение данных
Пункт меню | Описание
--- | --- 
Сопоставление (список) | Форма предназначена для анализа ввода и импорта сопоставления объектов КИСУР - СК-11, в частности для добавления сопоставленных ключей, которые необходимы, для обработки уже полученных (отложенных) сообщений из КИСУР.  Подробнее функционал описан в разделе [Отложенные сообщения и сопоставление](#4-отложенные-сообщения-и-сопоставление).
Сопоставление (иерархия) | Форма расширяет функциональность по вводу сопоставленных ключей возможностями просмотра объектов КИСУР в виде дерева и подбора сопоставленных объектов из дерева СК-11. Подробнее функционал описан в разделе [Отложенные сообщения и сопоставление](#4-отложенные-сообщения-и-сопоставление).

### 1.3. Отложенные сообщения

Пункт меню | Описание
--- | --- 
Список сообщений | Перечень отложенных сообщений с указанием статуса и просмотром подробностей по строке. Сообщение попадает в отложенные при отсутствии необходимого для его обработки сопоставления объектов КИСУР - СК-11. Недостающее сопоставление может быть добавлено в разделе "Обогащение данных", после чего сообщение направляется на повторную обработку. Подробнее функционал описан в разделе [Отложенные сообщения и сопоставление](#4-отложенные-сообщения-и-сопоставление).
Журнал обработки | Информация об операциях по применению сопоставленных ключей, заведенных в разделе "Обогащение данных", и обработке отложенных сообщений. Подробнее функционал описан в разделе [Отложенные сообщения и сопоставление](#4-отложенные-сообщения-и-сопоставление).

### 1.4. Мониторинг
Раздел предназначен для отслеживания состояния решения,диагностики проблем и отладки.
Пункт меню | Описание  | Источник данных
--- | ---  | ---
Входящие сооб. КИСУР | Перечень входящих сообщений полученных из системы КИСУР с возможностью просмотра сообщения в виде JSON | view_incomingMessages
Исходящие сооб. РГИС | Перечень исходящих сообщений в систему РГИС с возможностью просмотра сообщения в виде JSON | out_Rgis
Журнал операций | Журнал операций по выполнению правил обработки данных. Содержит: информацию о входном и выходном наборе данных, техническое описание алгоритма, ссылку на исходный файл в котором определено правило, информацию о продолжительности выполнения операции, количество затронутых записей, информацию об ошибке и др. | sys_PipelineLog
Журнал ошибок | Журнал ошибок (исключений) возникших при работе сервисов с возможностью просмотра подробностей по каждой ошибке | sys_Errors
Журнал информобмена | Содержит информацию об обмене данными с внешними системами. Помимо сообщений (которые также выводятся в предыдущих разделах) присутствуют xml diff, запросы ответы API. | view_messageLog

## 2. Функции компонентов интерфейса
В разделе перечислены стандартные функции компонентов интерфейса доступные на большинстве страниц. При этом на некоторых страницах отдельные функции могут быть не подключены.
### 2.1 Таблица
- Фильтрация - возможна фильтрация разными способами:
    - Фильтр на заголовке колонки с возможностью выбора значений из списка
    - Строка автофильтра с возможностью ввода текстовых значений для поиска и указанием операции ("равно","начинается", "содержит" и др.)
    - Конструктор фильтра. Позволяет задавать сложные выражения для фильтрации по нескольким колонкам с применением условий И, ИЛИ.
- Сортировка - выполняется щелчком на заголовок колонки. Возможна сортировка по нескольким колонкам, для этого нужно зажать SHIFT.
- Группировка - для группировки нужно перетащить заголовок колонки на специальную панель или выбрать соответствующий пункт в контекстном меню.
- Закрепление колонок - можно прикрепить колонку к левой или правой части таблицы,чтобы на нее не действовала горизонтальная прокрутка, функция доступна в контекстном меню на заголовке.
- Сохранение состояния. Текущие фильтр, сортировка и др. параметры записываются в URL строку браузера. При обновлении страницы или копировании ссылки состояние сохраняется.
- Экспорт в Excel

### 2.2 Дерево
- Фильтрация - доступны способы фильтрации аналогичные таблице. Применяется алгоритм фильтрации при котором в дереве показывается найденные узлы, а также все их дочерние и родительские узлы. Т.е., если, например, найти в дереве подстанцию по коду, то будет отображена сама подстанция, папка в которой она находится со всеми родительскими папками и все оборудование внутри подстанции.
- Сортировка - аналогично таблице.
- Сохранение состояния - аналогично таблице.
- Закрепление колонок - аналогично таблице.

## 3. Аутентификация и авторизация
Приложение использует единую систему аутентификация и авторизации keycloak.
Ведение учетных записей и ролей пользователей осуществляется в интерфейсе keycloak.
В приложении доступен просмотр ролей пользователя в меню, которое открывается при нажатии на имя пользователя.
В данный момент прописан следующий доступ для ролей.
- Аналитик - разделы "Витрины данных", "Обогащение данных", "Отложенные сообщения"
- Инженер, Эксперт, Администратор - раздел "Мониторинг"

## 4. Отложенные сообщения и сопоставление.
В данном разделе описано использования функционала по работе с отложенными сообщениями и сопоставлением на тестовом примере.
### 4.1. Инициализация БД. Ознакомление с загруженными данными.
Выполнить скрипт tools\scripts\init.py с включением необходимых блоков.
Скрипт загружает в БД:
- Модель СК-11 по ПС Землянск.
- Сопоставление объектов (при этом часть сопоставленных данных исключается для создания наглядного примера)
- Загружает другие данные и выполняет операции необходимые для подготовки системы к работе.

```python

from utils import Config, Database, Preparator
from scripts.common import InitUtils

# для создания искусственного примера для проверки отложенных сообщений
ignoreMatching = ["PS035-001986-14-01-201-85",
                  "PS035-001986-14-01-001-21",
                  "PS035-001986-13-01-001-10",
                  "PS035-001986-14-01-001-75",
                  "PS035-001986-14-01-001-70",
                  "PS035-001986-14-01-001",
                  "PS035-001986-14",
                  ]

Preparator.mongoUri = "mongodb://root:mrsksk11@mongodb.mrsk-sk11.oastu.lan:27017/admin?"
Config.mongoUri = "mongodb://root:eximer@mongodb.mrsk.oastu.lan:27017"
Config.exchangeDb = 'exchange-test'

withPlatform = False

InitUtils.prepareSystemForInit(withPlatform)
InitUtils.loadProjectData()
InitUtils.loadSkModel([
    r"YandexDisk\МРСК\Разное\Diff\Комплект\Землянск\Землянск-Folder.xml",
    r"YandexDisk\МРСК\Разное\Diff\Комплект\Землянск\Землянск.xml",
])


InitUtils.createMasterDataItems()

InitUtils.loadMatching(ignoreMatching)  # loadMatching processModel processMatching порядок важен
InitUtils.processModel()  # - в processModel используется Substation_IsSupplyCenter
# - в processMatching используется IdentifiedObject_RootContainer
InitUtils.processMatching()
InitUtils.loadTopologyMatching()
InitUtils.processTopologyMatching()

InitUtils.clearUnmatched()
InitUtils.importUnmatched()

# InitUtils.prepareDataForPlatform()
InitUtils.prepareDataMarts()
InitUtils.prepareMonitoredItems()
# InitUtils.prepareDataToRgis()
InitUtils.prepareDataForUi()

# InitUtils.sendMessagesToRgis()
# InitUtils.sendDiffToPlatform()
# InitUtils.downloadDiffForPlatform(r"C:\Bin\Diff\diff1.xml")

InitUtils.finalizeInit()

```

<b>Перезапустить сервис processor-api в kubernetes.</b>

Ознакомиться с данными на страницах:
- Обогащение данных/Сопоставление (список) - содержит перечень всех объектов КИСУР с указанием статусов
    - "Обработан" - для сопоставленных объектов
    - "Не сопоставлен" - для не сопоставленных объектов 

![](SPEC/2023-09-20-04-17-48.png)

- Обогащение данных/Сопоставление (иерархия) - те же данные в виде дерева в иерархии КИСУР

![](SPEC/2023-09-20-04-20-57.png)
### 4.2. Отправка сообщений. Анализ поступивших данных.
Выполнить скрипт tools\test\belchenko\test-tasks\MC-258\MC-258-2-msg.py \
Он отправляет набор сообщений с изменением оборудования по ПС Землянск.

```python
from utils import  Config, ServNames, System

Config.mongoUri = "mongodb://root:eximer@mongodb.mrsk.oastu.lan:27017"
Config.exchangeDb = 'exchange-test'

System.sendMessages(__file__ + "msg-new")
System.waitProcessing(
    [
        ServNames.mainProcessor,
        # ServNames.skOutgoing
    ]
)
```

После обработки сообщений ознакомиться с данным на страницах:
- Мониторинг/Входящие сооб. КИСУР - Показаны все входящие сообщения с указанием статуса "Принято" или "Отложено"
![](SPEC/2023-09-20-04-42-33.png)
- Отложенные сообщения/Список сообщений - Показаны отложенные сообщения. На этой странице вновь поступившие сообщения имеют статус "Требует сопоставления". В детализации показаны объекты, по которым нужно выполнить сопоставление.
![](SPEC/2023-09-20-04-41-55.png)
- Обогащение данных/Сопоставление (список) - Объекты по которым есть отложенные сообщения переместились наверх благодаря сортировке по полю дата сообщения.
![](SPEC/2023-09-20-04-45-18.png)

### 4.3. Ввод сопоставленных ключей вручную. Автоматические проверки.
Открыть страницу Обогащение данных/Сопоставление (список).
Для выполнения сопоставления нужно заполнить поле "Идентификатор СК-11".
Вновь сопоставленный объект получает статус "Готов".
![](SPEC/2023-09-20-04-59-17.png)
Предусмотрено несколько автоматических проверок на корректности выполненного сопоставление. При наличии ошибки выводится соответствующий статус.
- "Не найден" - если указан несуществующий идентификатор СК-11
- "Дубликат" - если указанный идентификатор СК-11 уже сопоставлен с другим объектом
- "Тип объекта не совпадает" - если не совпадает тип объекта по данным КИСУР с типом сопоставленного объекта в модели. 

Некоторые существующие объекты в КИСУР отсутствуют в СК-11, например фиктивные секции шин. Сообщения связанные таким объектам должны быть обработаны, но сопоставить их невозможно. Для того чтобы разрешить обработку такого объекта нужно установить флаг "Разрешить создание", если этот флаг установлен, объект будет обработан как новый.

Опробовать ввод корректных и некорректных данных проверить установку статуса.

Опробовать аналогичные операции на странице Обогащение данных/Сопоставление (иерархия).

Удалить вручную все изменения для выполнения следующих пунктов.

### 4.4. Экспорт/Импорт сопоставления.
Открыть страницу Обогащение данных/Сопоставление (список). \
Установить фильтр по полю "Дата сообщения" (выгрузка производится с учетом текущего установленного фильтра, можно выгружать и без фильтра целиком всю таблицу, это занимает немного больше времени)

![](SPEC/2023-09-20-05-16-45.png)

Выполнить экспорт данных в Excel кнопкой "ЭКСПОРТ".\
Открыть файл и внести изменения в колонки "Идентификатор СК-11", "Разрешить создание".

Сохранить файл и выполнить импорт с помощью кнопки "ИМПОРТ".\
Убедиться, что изменения сделанные в excel загрузились.

Удалить вручную все изменения для выполнения следующих пунктов.

### 4.5. Иерархия объектов. Выбор объектов для сопоставления из модели.
Описанный в данном пункте порядок предполагается как основной порядок работы пользователя при выполнении сопоставления.

- Пользователь видит объекты по которым требуется сопоставление в таблице Обогащение данных/Сопоставление (список)
- Выбирает объект и переходит в режим иерархии.
- В режиме иерархии отображаются рядом дерево объектов КИСУР и дерево объектов СК-11. При переходе из списка в иерархию страница иерархии отображается в контексте соответствующей подстанции.
- Пользователь выполняет сопоставление выделяя соответствующие строки в дереве КИСУР и дереве СК-11.
- После обработки объектов одной подстанции возвращается в список для выбора объекта следующей подстанции и выполнения сопоставления по ней.

Открыть страницу Обогащение данных/Сопоставление (список). \
Первыми в таблице показаны объекты, по которым требуется выполнить сопоставление для обработки отложенных сообщений. \
Выделить РУ PS035-001986-14 и нажать кнопку "ИЕРАРХИЯ"
![](SPEC/2023-09-20-05-32-17.png)
При этом открывается страница Обогащение данных/Сопоставление (иерархия).
В левой части дерево объектов КИСУР в дереве установлен фильтр по подстанции PS035-001986 в фокусе строка РУ PS035-001986-14.
![](SPEC/2023-09-20-05-48-31.png)
Справа дерево объектов СК-11, требуется найти в нем соответствующее РУ и выполнить сопоставление.
Для того чтобы открыть в дереве СК-11 место, где находится искомое РУ выделяем в дереве КИСУР находящий рядом уже сопоставленный объект, например саму подстанцию. И нажимаем кнопку "НАЙТИ В МОДЕЛИ".
![](SPEC/2023-09-20-05-55-20.png)
Переводим в дереве КИСУР фокус обратно на строку с РУ. При этом в дереве СК-11 подсвечиваются объекты подходящие для сопоставления с данным РУ. Это несопоставленные объекты соответствующего типа. 
![](SPEC/2023-09-20-05-59-13.png)
Выделяем подходящий РУ в дереве СК-11 и нажимаем кнопку "СОПОСТАВИТЬ"
![](SPEC/2023-09-20-06-00-50.png)
![](SPEC/2023-09-20-06-01-51.png)
Аналогичным образом сопоставляем ячейку
![](SPEC/2023-09-20-06-05-06.png)

Выше описан переход на страницу иерархии с автоматическим включением режима выбора. \
Также этот режим можно включить вручную если открыть страницу из главного меню и поставить флаг "Режим выбора" на патели инструментов. \
Есть возможность переключение раскладки на горизонтальную.
![](SPEC/2023-09-20-06-39-16.png)

### 4.5. Отображение результатов сопоставления в списке отложенных сообщений.
Открыть страницу Отложенные сообщения/Список сообщений. \
Видно что 5 из 6-ти сообщений теперь готовы к обработке, а одно из сообщений по прежнему имеет статус "Требуется сопоставление" потому, что один из объектов не сопоставлен. 
![](SPEC/2023-09-20-06-15-02.png)

### 4.5. Применение результатов сопоставления.
В результате выполнения операции сопоставленные ключи записываются в модель и запускается обработка отложенных сообщений, для которых обработка стала доступной в результате выполненного сопоставления.

Открыть страницу Обогащение данных/Сопоставление (список). \
Нажать кнопку "ПРИМЕНИТЬ". \
При этом будет открыто диалоговое окно для подтверждения с информацией о выполняемой операции. \
![](SPEC/2023-09-20-06-09-00.png)
Возможна частичное применение результатов сопоставления, сопоставление для обработки собирается с учетом текущего фильтра таблицы. \
Нажать "ОК". \
![](SPEC/2023-09-20-06-21-00.png)

### 4.5. Просмотр результатов обработки (применения результатов сопоставления).
Открыть страницу Отложенные сообщения/Журнал обработки. \
В журнале отображается информация о выполненной операции с возможностью просмотра деталей. \
![](SPEC/2023-09-20-06-23-22.png) \
![](SPEC/2023-09-20-06-24-03.png) \

Открыть страницу Отложенные сообщения/Список сообщений. \
Для обработанных сообщений отображается соответствующий статус. \
![](SPEC/2023-09-20-06-26-15.png)


Открыть страницу Мониторинг/Входящие сооб. КИСУР. \
На этой странице видно, что отложенные сообщения "отправлены" повторно и на этот раз приняты.
![](SPEC/2023-09-20-06-29-29.png)